name: Build OpenTaiko

on: 
  schedule:
    - cron: '0 0 12 1/1 *'
  workflow_dispatch:
  
jobs:
  sync:
    permissions:
      actions: write
      checks: write
      contents: write
      deployments: write
      issues: write
      packages: write
      pull-requests: write
      repository-projects: write
      security-events: write
      statuses: write
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Merge upstream
        run: |
          git config --global user.name ${NAME}
          git config --global user.email ${EMAIL}
          git config --global pull.rebase merges
          git pull --unshallow
          git remote add upstream ${REPO_FORK}
          git fetch upstream
          git checkout main
          git merge --no-edit upstream/main
          git push origin main
        env:
          NAME: totoa553
          EMAIL: ${{ env.EMAIL }}
          REPO_FORK: https://github.com/0auBSQ/OpenTaiko.git

      - name: Setup MSBuild.exe
        uses: microsoft/setup-msbuild@v1

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Restore the application
        run: nuget restore $Env:GITHUB_WORKSPACE\TJAPlayer3.sln

      - name: Install component on windows 2022
        shell: pwsh
        run: |
          Set-Location "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"
          $InstallPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
          $componentsToAdd = @(
            "Microsoft.Net.Component.4.6.1.SDK"
          )
          [string]$workloadArgs = $componentsToAdd | ForEach-Object {" --add " +  $_}
          $Arguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$workloadArgs, '--quiet', '--norestart', '--nocache')
          $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden
          if ($process.ExitCode -eq 0)
          {
              Write-Host "components have been successfully added"
          }
          else
          {
              Write-Host "components were not installed"
              exit 1
          }

      - name: Build the Solution(x64)
        run: MSBuild.exe $Env:GITHUB_WORKSPACE\TJAPlayer3.sln -p:Configuration=Release -p:platform=x64
        timeout-minutes: 5

      - name: Create Archive(x64)
        run: |
          cd $Env:GITHUB_WORKSPACE
          tar -a -cvf OpenTaiko.zip -C Test *

      - name: Build the Solution(x86)
        run: MSBuild.exe $Env:GITHUB_WORKSPACE\TJAPlayer3.sln -p:Configuration=Release -p:platform=x86
        timeout-minutes: 5

      - name: Create Archive(x86)
        run: |
          cd $Env:GITHUB_WORKSPACE
          tar -a -cvf OpenTaiko(x86).zip -C Test *

      - name: Get Current Time
        id: time
        shell: pwsh
        run: |
          echo "::set-output name=time::$((Get-Date).addHours(9))"

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-${{ github.sha }}
          release_name: Release on ${{ steps.time.outputs.time }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./*.zip
          asset_content_type: application/zip
